<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://code.jquery.com/jquery-3.6.3.min.js" integrity="sha256-pvPw+upLPUjgMXY0G+8O0xUf+/Im1MZjXxxgOcBQBXU=" crossorigin="anonymous"></script>
  <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.3.3/axios.min.js" integrity="sha512-wS6VWtjvRcylhyoArkahZUkzZFeKB7ch/MHukprGSh1XIidNvHG1rxPhyFnL73M0FC1YXPIXLRDAoOyRJNni/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script> -->
  <script src="https://cdn.jsdelivr.net/npm/axios@1.3.3/dist/axios.min.js"></script>
  <script src="./index.js"></script>
  <title>View Email As Web</title>
</head>
<body>
  <form>
    <label for="emailAddress"></label>
    <input type="text" id="emailAddress" name="emailAddress"/>
    <button id="searchEmailAddress" value="Search" type="button">Search</button>
  </form>
  <div id="emailPreviewTable"></div>
  <hr>
  <div id="downloadLink"></div>
  <hr>
  <div id="emailPreviewSection"></div>
  <!-- <script src="./index.js"></script> -->
  <script>
    // const production  = 'https://sfmvawp.herokuapp.com/';
    // const development = 'http://localhost:8080/';
    // const url = (process.env.NODE_ENV ? production : development);

    $('#searchEmailAddress').on('click',function(event){
      let email = $("#emailAddress").val()
      console.log($("#emailAddress").val());
      axios.get(url+'/search/' + email)
        .then(function(response){
          console.log(response)
          let emailTable = "<table border=1><tr><td><b>EmailName</b></td><td><b>View Email URL</b></td><td><b>Download</b></td></tr>";
          if(response.status == 200){
            //Show table
            for(i in response.data.emails){
              emailTable += '<tr><td>' + response.data.emails[i]['EmailName'] + '</td><td><a class="ck-viewEmailAction" customHref="' + response.data.emails[i]['View_Email_URL'] + '" target="_blank" style="color:#0000EE;  text-decoration: underline;"> View Email </a></td><td><a class="ck-downloadEmailAction" customHref="' + response.data.emails[i]['View_Email_URL'] + '" target="_blank"  style="color:#0000EE;  text-decoration: underline;"> Download PDF </a></td></tr>';
            }
            emailTable += "</table>"
            $("#emailPreviewTable").html(emailTable);

            //set event listners 
            $('.ck-viewEmailAction').on('click', function(){
              var view_email_url = $(this).attr('customHref');
              let body = {
                'view_email_url' : view_email_url
              }
              axios.post(url+'/preview', body)
                .then(function(response){
                  console.log(response)
                  let previewHtml = response.data;
                  $('#emailPreviewSection').html(previewHtml);
                })
                .catch(function(error){
                  console.log(response)
                });

              console.log('clicked ' , $(this).attr('customHref'));
            });

            $('.ck-downloadEmailAction').on('click', function(){
              var download_email_url = $(this).attr('customHref');
              let body = {
                'download_email_url' : download_email_url
              }
              axios.post(url+'/download', body)
                .then(function(response){
                  console.log('Download response ' , response)
                  if(response.status == 200) {
                    let downloadableLocation = response.data.fileLocation;
                    $('#downloadLink').html('<a href="' + downloadableLocation + '" target="_blank">Download PDF from here</a>')
                  }//If response.status == 200 ends 
                })
                .catch(function(error){
                  console.log(response)
                });

              console.log('clicked ' , $(this).attr('customHref'));
            });

          }//If response,status=200 ends
        })
        .catch(function(error){
          console.log(error)
        });
    })
  </script>

</body>
</html>